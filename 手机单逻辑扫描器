# -*- coding: utf-8 -*-
"""
ğŸ“± Pydroidï½œBinance å®ç›˜ä¿¡å·æ‰«æå™¨
é€»è¾‘ï¼šBIG_GREEN_THEN_RED_SHORT
ä»…æ§åˆ¶å°è¾“å‡º
"""

import requests
import pandas as pd
import time
from datetime import datetime

# ================== å‚æ•° ==================
BASE_URL = "https://fapi.binance.com"
INTERVAL = "1d"
KLINE_LIMIT = 3

TP = 0.02
INVEST = 20
LEVERAGE = 20

BLACKLIST = ["TRXUSDT"]

# ================== å·¥å…·å‡½æ•° ==================
def candle_down(c):
    return c["close"] < c["open"]

def get_symbols():
    r = requests.get(
        f"{BASE_URL}/fapi/v1/exchangeInfo",
        timeout=10
    ).json()

    return [
        s["symbol"]
        for s in r["symbols"]
        if s["quoteAsset"] == "USDT"
        and s["contractType"] == "PERPETUAL"
        and s["status"] == "TRADING"
    ]

def fetch_klines(symbol):
    r = requests.get(
        f"{BASE_URL}/fapi/v1/klines",
        params={
            "symbol": symbol,
            "interval": INTERVAL,
            "limit": KLINE_LIMIT
        },
        timeout=10
    ).json()

    if not isinstance(r, list) or len(r) < 2:
        return None

    df = pd.DataFrame(r, columns=[
        "t","open","high","low","close","v",
        "ct","qv","n","tb","tq","i"
    ])
    df[["open", "close"]] = df[["open", "close"]].astype(float)
    return df

# ================== è§¦å‘é€»è¾‘ï¼ˆä¸¥æ ¼æŒ‰ä½ ç»™çš„ï¼‰ ==================
def trigger_BIG_GREEN_THEN_RED_SHORT(df_s, idx):
    if idx < 1:
        return False
    prev = df_s.iloc[idx - 1]
    last = df_s.iloc[idx]
    return (prev["close"] > prev["open"] * 1.07) and candle_down(last)

# ================== æ‰«æå¯åŠ¨ ==================
print("=" * 80)
print("ğŸš¨ BIG_GREEN_THEN_RED_SHORTï½œå®ç›˜æ‰«æå¯åŠ¨")
print("æ—¶é—´ï¼š", datetime.now())
print("=" * 80)

symbols = get_symbols()
signal_count = 0

for symbol in symbols:
    if symbol in BLACKLIST:
        continue

    try:
        df = fetch_klines(symbol)
        if df is None:
            continue

        idx = len(df) - 1
        if not trigger_BIG_GREEN_THEN_RED_SHORT(df, idx):
            continue

        entry = df.iloc[idx]["open"]
        tp_price = round(entry * (1 - TP), 6)
        profit_u = round(INVEST * LEVERAGE * TP, 2)

        print(f"\nğŸ”´ {symbol}")
        print(f"   å‰ä¸€æ—¥å¤§é˜³ï¼ˆ+7%ï¼‰ + ä»Šæ—¥é˜´çº¿")
        print(f"   å…¥åœºä»·ï¼š{entry}")
        print(f"   æ­¢ç›ˆä»·ï¼š{tp_price}")
        print(f"   ä»“ä½ï¼š{INVEST}U Ã— {LEVERAGE}x ï½œâ‰ˆ +{profit_u}U")

        signal_count += 1
        time.sleep(0.3)

    except Exception as e:
        print(f"âš ï¸ {symbol} å‡ºé”™ï¼š{e}")
        continue

print("\n" + "=" * 80)
print(f"âœ… æ‰«æå®Œæˆ ï½œ æœ¬è½®ä¿¡å·æ•°ï¼š{signal_count}")
print("=" * 80)
