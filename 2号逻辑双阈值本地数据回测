# -*- coding: utf-8 -*-
"""
ğŸ“Š æœ¬åœ° CSV åŒé˜ˆå€¼ BIG_GREEN_THEN_RED_SHORT å›æµ‹
é€»è¾‘ï¼š
- å‰ä¸€å¤©å¤§é˜³è¶…è¿‡é˜ˆå€¼
- å½“å¤©æ”¶é˜´ -> ç¬¬äºŒå¤©å¼€ç©º
- æŒæœ‰åˆ°æœ€åä¸€æ ¹Kçº¿
- åŒé˜ˆå€¼ 1.07 / 1.08
- è¾“å‡ºäº¤æ˜“è®°å½• CSV + æ§åˆ¶å°é£é™©ç”»åƒ
"""

import pandas as pd

# ================= å‚æ•° =================
CSV_FILE = r"C:\Users\JZDD\Desktop\all_usdt_perp_1d_20260101_1625.csv"
OUTPUT_CSV = r"C:\Users\JZDD\Desktop\big_green_red_backtest.csv"
THRESHOLDS = [1.07, 1.08]
INVEST = 20
LEVERAGE = 20

# ================= è¯»å–æ•°æ® =================
df = pd.read_csv(CSV_FILE)
df[["open","high","low","close"]] = df[["open","high","low","close"]].astype(float)
df["date"] = pd.to_datetime(df["date"])
df = df.sort_values(["symbol","date"]).reset_index(drop=True)

# ================= å·¥å…·å‡½æ•° =================
def candle_down(c): return c['close'] < c['open']
def big_green(c, ratio): return c['close'] > c['open'] * ratio

# ================= å›æµ‹å‡½æ•° =================
def backtest_symbol(df_s, ratio):
    trades = []
    n = len(df_s)
    for i in range(1, n-1):  # ä»ç¬¬äºŒè¡Œå¼€å§‹
        prev = df_s.iloc[i-1]
        curr = df_s.iloc[i]
        next_candle = df_s.iloc[i+1]
        if big_green(prev, ratio) and candle_down(curr):
            entry_price = next_candle["open"]
            entry_date = next_candle["date"]

            # æŒä»“åˆ°æœ€åä¸€æ ¹Kçº¿
            exit_price = df_s.iloc[-1]["close"]
            exit_date = df_s.iloc[-1]["date"]
            held_days = (df_s.iloc[-1].name - next_candle.name) + 1

            # æœ€å¤§æµ®äºï¼šç©ºå•ï¼Œé«˜ç‚¹ç›¸å¯¹å…¥åœº
            peak_loss = ((df_s.iloc[next_candle.name:i+1+held_days]["high"].max() - entry_price)/entry_price*INVEST*LEVERAGE) if held_days>0 else 0
            profit = (entry_price - exit_price) * INVEST * LEVERAGE / entry_price

            trades.append({
                "symbol": df_s.iloc[0]["symbol"],
                "logic": f"BIG_GREEN_THEN_RED_SHORT_{ratio}",
                "threshold": ratio,
                "entry_date": entry_date,
                "entry_price": entry_price,
                "exit_date": exit_date,
                "exit_price": exit_price,
                "held_days": held_days,
                "profit": round(profit,2),
                "max_drawdown": round(peak_loss,2)
            })
    return trades

# ================= ä¸»ç¨‹åº =================
all_trades = []
symbols = df["symbol"].unique()

for sym in symbols:
    df_s = df[df["symbol"]==sym].reset_index(drop=True)
    for ratio in THRESHOLDS:
        trades = backtest_symbol(df_s, ratio)
        all_trades.extend(trades)

# ================= è¾“å‡º =================
if all_trades:
    out_df = pd.DataFrame(all_trades)
    out_df.to_csv(OUTPUT_CSV, index=False, encoding="utf-8-sig")
    print(f"\nâœ… å›æµ‹å®Œæˆï¼Œäº¤æ˜“è®°å½•å·²ä¿å­˜: {OUTPUT_CSV}")

    # æ§åˆ¶å°é£é™©ç”»åƒ
    for ratio in THRESHOLDS:
        df_r = out_df[out_df["threshold"]==ratio]
        triggers = len(df_r)
        wins = len(df_r[df_r["profit"]>0])
        losses = triggers - wins
        winrate = wins/triggers*100 if triggers>0 else 0
        max_held = df_r["held_days"].max()
        max_dd = df_r["max_drawdown"].max()
        print("\n" + "="*60)
        print(f"ğŸ“Š é˜ˆå€¼ {ratio} é£é™©ç”»åƒ")
        print(f"è§¦å‘æ¬¡æ•°: {triggers}")
        print(f"ç›ˆåˆ©æ¬¡æ•°: {wins} | äºæŸæ¬¡æ•°: {losses} | èƒœç‡: {winrate:.2f}%")
