# -*- coding: utf-8 -*-
"""
æœ¬åœ° CSV å›æµ‹ï½œ1.07 / 1.08 åŒé˜ˆå€¼
"""

import pandas as pd
from tqdm import tqdm

# ================= å‚æ•° =================
CSV_PATH = r"C:\Users\JZDD\Desktop\all_usdt_perp_1d_20260101_1625.csv"

THRESHOLDS = [1.07, 1.08]
TAKE_PROFIT = 0.02
INVEST_USDT = 100
LEVERAGE = 20

# ================= è¯»å–æ•°æ® =================
df = pd.read_csv(CSV_PATH)

df[['open', 'high', 'low', 'close']] = df[['open', 'high', 'low', 'close']].astype(float)

# ç¡®ä¿åŒä¸€åˆçº¦æŒ‰æ—¶é—´æ’åº
df = df.sort_values(['symbol', 'date']).reset_index(drop=True)

# ================= ä¿¡å·å‡½æ•° =================

def candle_down(c):
    return c['close'] < c['open']

def big_green(c, ratio):
    return c['close'] > c['open'] * ratio

# ================= å›æµ‹å‡½æ•° =================

def backtest(symbol_df, ratio):
    wins = 0
    losses = 0
    max_drawdown = 0
    max_hold_days = 0

    for i in range(len(symbol_df) - 2):
        prev = symbol_df.iloc[i]
        curr = symbol_df.iloc[i + 1]

        if big_green(prev, ratio) and candle_down(curr):
            entry = symbol_df.iloc[i + 2]['open']
            tp = entry * (1 - TAKE_PROFIT)

            peak_loss = 0
            hold_days = 0

            for j in range(i + 2, len(symbol_df)):
                k = symbol_df.iloc[j]
                hold_days += 1

                # ç©ºå•æµ®äº = æœ€é«˜ä»·ä¸Šæ¶¨
                drawdown = (k['high'] - entry) / entry * INVEST_USDT * LEVERAGE
                peak_loss = max(peak_loss, drawdown)

                if k['low'] <= tp:
                    wins += 1
                    break
            else:
                losses += 1

            max_drawdown = max(max_drawdown, peak_loss)
            max_hold_days = max(max_hold_days, hold_days)

    total = wins + losses
    winrate = wins / total * 100 if total else 0

    return {
        "triggers": total,
        "wins": wins,
        "losses": losses,
        "winrate": round(winrate, 2),
        "max_hold_days": max_hold_days,
        "max_drawdown_usdt": round(max_drawdown, 2)
    }

# ================= ä¸»ç¨‹åº =================

symbols = df['symbol'].unique()

for ratio in THRESHOLDS:
    print("\n" + "=" * 60)
    print(f"ğŸ“Š å›æµ‹é˜ˆå€¼ï¼š{ratio}")

    agg = {
        "triggers": 0,
        "wins": 0,
        "losses": 0,
        "max_hold_days": 0,
        "max_drawdown_usdt": 0
    }

    for symbol in tqdm(symbols, desc=f"é˜ˆå€¼ {ratio} å›æµ‹è¿›åº¦"):
        s_df = df[df['symbol'] == symbol].reset_index(drop=True)
        if len(s_df) < 10:
            continue

        r = backtest(s_df, ratio)

        for k in agg:
            if k in r:
                agg[k] = max(agg[k], r[k]) if 'max_' in k else agg[k] + r[k]

    total = agg['wins'] + agg['losses']
    winrate = agg['wins'] / total * 100 if total else 0

    print(f"""
è§¦å‘æ¬¡æ•°: {agg['triggers']}
ç›ˆåˆ©æ¬¡æ•°: {agg['wins']} | äºæŸæ¬¡æ•°: {agg['losses']}
èƒœç‡: {winrate:.2f}%
æœ€å¤§æŒä»“å¤©æ•°: {agg['max_hold_days']}
æœ€å¤§å•ç¬”æµ®äº: {agg['max_drawdown_usdt']} USDT
""")
