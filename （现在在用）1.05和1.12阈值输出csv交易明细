# -*- coding: utf-8 -*-
"""
ğŸ“Š æœ¬åœ° CSV å¤šé˜ˆå€¼ BIG_GREEN_THEN_RED_SHORT å›æµ‹ï¼ˆè¾“å‡º CSVï¼‰
é€»è¾‘ï¼š
- å‰ä¸€å¤©å¤§é˜³è¶…è¿‡é˜ˆå€¼
- å½“å¤©æ”¶é˜´
- ç¬¬äºŒå¤©æ”¶é˜´ -> ç¬¬äºŒå¤©å¼€ç©º
- å›ºå®š 2% æ­¢ç›ˆ
- é˜ˆå€¼ï¼š1.05, 1.12
- è¾“å‡º CSVï¼ˆè¯¦ç»†äº¤æ˜“è®°å½•ï¼‰
"""

import pandas as pd
from tqdm import tqdm
import numpy as np

# ================= å‚æ•° =================
CSV_FILE = r"C:\Users\JZDD\Desktop\all_usdt_perp_1d_20260101_1625.csv"
INVEST = 20
LEVERAGE = 20
TP = 0.02  # æ­¢ç›ˆæ¯”ä¾‹
THRESHOLDS = [1.05, 1.12]  # åªå›æµ‹è¿™ä¸¤ä¸ªé˜ˆå€¼
OUTPUT_CSV = r"C:\Users\JZDD\Desktop\big_green_then_red_trades.csv"

# ================= è¯»å–æ•°æ® =================
df = pd.read_csv(CSV_FILE)
df[["open","high","low","close"]] = df[["open","high","low","close"]].astype(float)
df["date"] = pd.to_datetime(df["date"])
df = df.sort_values(["symbol","date"]).reset_index(drop=True)

# ================= å·¥å…·å‡½æ•° =================
def candle_down(c): return c['close'] < c['open']
def big_green(c, ratio): return c['close'] > c['open'] * ratio

# ================= å›æµ‹å‡½æ•° =================
def backtest_symbol(df_s, ratio):
    trades = []
    n = len(df_s)
    for i in range(1, n-2):  # æœ€åä¸€å¤©ä¸èƒ½å¼€ä»“
        prev = df_s.iloc[i-1]      # å‰ä¸€å¤©
        curr = df_s.iloc[i]        # å½“å¤©
        next_candle = df_s.iloc[i+1] # ç¬¬äºŒå¤©ï¼ˆå¼€ä»“æ—¥ï¼‰

        # ä¸¥æ ¼é€»è¾‘ï¼šå‰ä¸€å¤©å¤§é˜³ + å½“å¤©æ”¶é˜´ + ç¬¬äºŒå¤©æ”¶é˜´
        if big_green(prev, ratio) and candle_down(curr) and candle_down(next_candle):
            entry_price = next_candle["open"]
            entry_date = next_candle["date"]
            tp_price = entry_price * (1 - TP)

            # æŒä»“åˆ°æ­¢ç›ˆæˆ–æœ€åä¸€æ ¹ K
            exit_price = entry_price
            exit_date = entry_date
            peak_loss = 0
            held_days = 0
            for j in range(next_candle.name, n):
                high = df_s.iloc[j]["high"]
                low = df_s.iloc[j]["low"]
                # ç©ºå•æ­¢ç›ˆ
                if low <= tp_price:
                    exit_price = tp_price
                    exit_date = df_s.iloc[j]["date"]
                    held_days = j - next_candle.name + 1
                    break
                # æ›´æ–°æµ®äº
                peak_loss = max(peak_loss, (high - entry_price)/entry_price*INVEST*LEVERAGE)
            else:
                exit_price = df_s.iloc[-1]["close"]
                exit_date = df_s.iloc[-1]["date"]
                held_days = df_s.iloc[-1].name - next_candle.name + 1

            profit = (entry_price - exit_price)/entry_price * INVEST * LEVERAGE

            trades.append({
                "symbol": df_s.iloc[0]["symbol"],
                "threshold": round(ratio,2),
                "entry_date": entry_date,
                "entry_price": entry_price,
                "exit_date": exit_date,
                "exit_price": exit_price,
                "held_days": held_days,
                "profit": round(profit,2),
                "max_drawdown": round(peak_loss,2)
            })
    return trades

# ================= ä¸»ç¨‹åº =================
symbols = df["symbol"].unique()
all_trades_final = []

for ratio in THRESHOLDS:
    all_trades = []
    print("\n" + "="*80)
    print(f"ğŸ“Š å¼€å§‹å›æµ‹ é˜ˆå€¼ {ratio:.2f}")

    for sym in tqdm(symbols, desc=f"å›æµ‹è¿›åº¦ {ratio:.2f}"):
        df_s = df[df["symbol"]==sym].reset_index(drop=True)
        trades = backtest_symbol(df_s, ratio)
        all_trades.extend(trades)

    if all_trades:
        out_df = pd.DataFrame(all_trades)
        all_trades_final.append(out_df)

        triggers = len(out_df)
        wins = len(out_df[out_df["profit"]>0])
        losses = triggers - wins
        winrate = wins/triggers*100 if triggers>0 else 0
        max_held = out_df["held_days"].max()
        max_dd = out_df["max_drawdown"].max()
        total_profit = out_df["profit"].sum()

        print(f"\nğŸ“Š é˜ˆå€¼ {ratio:.2f} é£é™©ç”»åƒ")
        print(f"è§¦å‘æ¬¡æ•°: {triggers}")
        print(f"ç›ˆåˆ©æ¬¡æ•°: {wins} | äºæŸæ¬¡æ•°: {losses} | èƒœç‡: {winrate:.2f}%")
        print(f"æœ€é•¿æŒä»“å¤©æ•°: {max_held} å¤©")
        print(f"æœ€å¤§æµ®äº: {max_dd:.2f} USDT")
        print(f"ç´¯è®¡å‡€æ”¶ç›Š: {total_profit:.2f} USDT")
    else:
        print(f"âš  é˜ˆå€¼ {ratio:.2f} æ²¡æœ‰è§¦å‘ä»»ä½•ä¿¡å·")

# ================= è¾“å‡º CSV =================
if all_trades_final:
    final_df = pd.concat(all_trades_final, ignore_index=True)
    final_df.to_csv(OUTPUT_CSV, index=False)
    print(f"\nâœ… è¯¦ç»†äº¤æ˜“è®°å½•å·²ä¿å­˜åˆ° {OUTPUT_CSV}")
