# -*- coding: utf-8 -*-
"""
ğŸ“¡ å®ç›˜æ‰«æå™¨ + å³æ—¶å›æµ‹
ç­–ç•¥ï¼šBIG_GREEN_RED_5%
- æ—¥çº¿ï¼Œä»£ç ä¿®æ”¹ï¼Œåœ¨æ§åˆ¶å°è¿˜è¦æ˜¾ç¤ºå†å²è·åˆ©å¤šå°‘ï¼Œå¦‚æœåç¦»å¤§äº2%æŠ˜å ä¿¡æ¯ï¼Œæ‰“ä¸ªçº¢å‰ã€‚å†è§£ç­”æˆ‘çš„é—®é¢˜ï¼Œæœ‰æ²¡æœ‰æœªæ¥å‡½æ•°é—®é¢˜ï¼Œèƒ½å¦å½“å¤©ç›˜ä¸­ä½¿ç”¨ï¼Œæˆ‘æ˜¯å½“å¤©å…¥åœºä¼šä¸ä¼šå­˜åœ¨æœªæ¥å‡½æ•°é—®é¢˜
- æ— æœªæ¥å‡½æ•°
- å½“å‰ä»·æ ¼åˆ¤æ–­æ˜¯å¦åç¦»
"""

import requests
import pandas as pd
from tqdm import tqdm
import time

# ================= å‚æ•° =================
BASE_URL = "https://fapi.binance.com"
INTERVAL = "1d"
LIMIT = 300

INVEST = 20
LEVERAGE = 20
TP = 0.02                 # æ­¢ç›ˆ 2%
MAX_DEVIATION = 0.02      # å½“å‰ä»·æ ¼æœ€å¤§å…è®¸åç¦» 2%

# ================= å·¥å…·å‡½æ•° =================
def get_symbols():
    r = requests.get(f"{BASE_URL}/fapi/v1/exchangeInfo").json()
    return [
        s["symbol"] for s in r["symbols"]
        if s["contractType"] == "PERPETUAL"
        and s["quoteAsset"] == "USDT"
        and s["status"] == "TRADING"
    ]

def get_klines(symbol):
    params = {
        "symbol": symbol,
        "interval": INTERVAL,
        "limit": LIMIT
    }
    r = requests.get(f"{BASE_URL}/fapi/v1/klines", params=params, timeout=10)
    data = r.json()
    df = pd.DataFrame(data, columns=[
        "open_time","open","high","low","close","volume",
        "close_time","qv","n","tb","tq","ignore"
    ])
    df[["open","high","low","close"]] = df[["open","high","low","close"]].astype(float)
    return df

def get_price(symbol):
    r = requests.get(f"{BASE_URL}/fapi/v1/ticker/price", params={"symbol": symbol})
    return float(r.json()["price"])

# ================= ä¿¡å·åˆ¤æ–­ =================
def is_signal(df):
    prev2 = df.iloc[-3]   # å‰å‰å¤©ï¼ˆå·²æ”¶ç›˜ï¼‰
    prev1 = df.iloc[-2]   # å‰ä¸€å¤©ï¼ˆå·²æ”¶ç›˜ï¼‰

    cond1 = prev2["close"] >= prev2["open"] * 1.05
    cond2 = prev1["close"] < prev1["open"]

    return cond1 and cond2

# ================= å›æµ‹å‡½æ•° =================
def backtest(df):
    trades = []
    n = len(df)

    for i in range(2, n - 1):
        prev2 = df.iloc[i-2]
        prev1 = df.iloc[i-1]

        if not (prev2["close"] >= prev2["open"] * 1.05 and prev1["close"] < prev1["open"]):
            continue

        entry = df.iloc[i]
        entry_price = entry["open"]
        tp_price = entry_price * (1 - TP)

        max_dd = 0
        exit_idx = None
        exit_price = None

        for j in range(i, n):
            k = df.iloc[j]
            dd = (k["high"] - entry_price) / entry_price * INVEST * LEVERAGE
            max_dd = max(max_dd, dd)

            if k["low"] <= tp_price:
                exit_idx = j
                exit_price = tp_price
                break

        if exit_idx is None:
            exit_idx = n - 1
            exit_price = df.iloc[-1]["close"]

        profit = (entry_price - exit_price) / entry_price * INVEST * LEVERAGE
        trades.append({
            "profit": profit,
            "max_dd": max_dd,
            "hold_days": exit_idx - i + 1
        })

    if not trades:
        return None

    tdf = pd.DataFrame(trades)
    return {
        "trades": len(tdf),
        "winrate": (tdf["profit"] > 0).mean() * 100,
        "total_profit": tdf["profit"].sum(),
        "max_drawdown": tdf["max_dd"].max(),
        "avg_hold": tdf["hold_days"].mean()
    }

# ================= ä¸»æ‰«æ =================
symbols = get_symbols()
print(f"ğŸ” æ‰«æåˆçº¦æ•°é‡ï¼š{len(symbols)}")

for sym in tqdm(symbols, desc="å®ç›˜æ‰«æä¸­"):
    try:
        df = get_klines(sym)
        if len(df) < 10:
            continue

        if not is_signal(df):
            continue

        today = df.iloc[-1]
        entry_price = today["open"]
        current_price = get_price(sym)

        deviation = (entry_price - current_price) / entry_price

        stats = backtest(df)

        print("\n" + "="*70)
        print(f"ğŸ“Œ åˆçº¦ï¼š{sym}")
        print("æ–¹å‘ï¼šåšç©º")
        print(f"ç†è®ºå…¥åœºä»·ï¼ˆä»Šæ—¥ openï¼‰ï¼š{entry_price:.4f}")
        print(f"å½“å‰ä»·æ ¼ï¼š{current_price:.4f}")
        print(f"å·²åç¦»ï¼š{deviation*100:.2f}%")

        if deviation >= MAX_DEVIATION:
            print("âŒ åç¦»è¶…è¿‡2%ï¼Œä¿¡æ¯æŠ˜å ")
            if stats:
                print(f"å†å²æ€»è·åˆ©ï¼š{stats['total_profit']:.2f} USDT")
        else:
            if stats:
                print(f"å†å²äº¤æ˜“æ¬¡æ•°ï¼š{stats['trades']}")
                print(f"èƒœç‡ï¼ˆ2%ï¼‰ï¼š{stats['winrate']:.2f}%")
                print(f"å†å²æ€»è·åˆ©ï¼š{stats['total_profit']:.2f} USDT")
                print(f"æœ€å¤§å›æ’¤ï¼š{stats['max_drawdown']:.2f} USDT")
                print(f"å¹³å‡æŒä»“ï¼š{stats['avg_hold']:.2f} å¤©")

        time.sleep(0.1)

    except Exception as e:
        continue
