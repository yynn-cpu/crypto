# -*- coding: utf-8 -*-
"""
ğŸ“Š Registry å›æµ‹ç³»ç»Ÿ Â· 4 æ¡ç‹¬ç«‹é€»è¾‘
- æ— æœªæ¥å‡½æ•°
- å•åˆçº¦å•ä»“
- è¾“å‡ºé€ç¬”äº¤æ˜“ + ç­–ç•¥æ±‡æ€»
- ç»Ÿè®¡å®ç° 2% æ­¢ç›ˆçš„æ¦‚ç‡ï¼ˆèƒœç‡ï¼‰
"""

import pandas as pd
from tqdm import tqdm

# ================= å‚æ•° =================
CSV_FILE = r"C:\Users\1\all_usdt_perp_1d_20251225_2256.csv"
TRADES_CSV = r"C:\Users\1\Desktop\registry_trade_details_FINAL.csv"
SUMMARY_CSV = r"C:\Users\1\Desktop\registry_strategy_summary_FINAL.csv"

INVEST = 20
LEVERAGE = 20
TP = 0.02  # å›ºå®šæ­¢ç›ˆ 2%

# ================= ç­–ç•¥æ³¨å†Œè¡¨ =================
STRATEGIES = [
    {"name": "BIG_GREEN_RED_105", "type": "A", "ratio": 1.05},
    {"name": "BIG_GREEN_RED_112", "type": "A", "ratio": 1.12},
    {"name": "THREE_RED", "type": "B"},
    {"name": "ONE_UP_THREE_DOWN", "type": "C"}
]

# ================= æ•°æ®è¯»å– =================
df = pd.read_csv(CSV_FILE)
df[["open", "high", "low", "close"]] = df[["open", "high", "low", "close"]].astype(float)
df["date"] = pd.to_datetime(df["date"])
df = df.sort_values(["symbol", "date"]).reset_index(drop=True)

# ================= å·¥å…·å‡½æ•° =================
def is_red(c): return c["close"] < c["open"]
def is_big_green(c, ratio): return c["close"] > c["open"] * ratio

def three_red(df_s, i):
    return is_red(df_s.iloc[i]) and is_red(df_s.iloc[i-1]) and is_red(df_s.iloc[i-2])

def one_up_three_down(df_s, i):
    # i-3: é˜³çº¿, i-2, i-1, i: é˜´çº¿
    return (df_s.iloc[i-3]["close"] > df_s.iloc[i-3]["open"] and
            is_red(df_s.iloc[i-2]) and is_red(df_s.iloc[i-1]) and is_red(df_s.iloc[i]))

# ================= å•ç­–ç•¥å•åˆçº¦å›æµ‹ =================
def backtest_symbol_strategy(df_s, strategy):
    trades = []
    n = len(df_s)
    i = 3 if strategy["type"] == "C" else 2  # Cé€»è¾‘éœ€è¦i-3

    while i < n - 1:
        signal = False

        if strategy["type"] == "A":
            signal = is_big_green(df_s.iloc[i - 1], strategy["ratio"]) and is_red(df_s.iloc[i])
        elif strategy["type"] == "B":
            signal = three_red(df_s, i)
        elif strategy["type"] == "C":
            signal = one_up_three_down(df_s, i)

        if not signal:
            i += 1
            continue

        # ---------- å…¥åœºï¼ˆi+1 å¼€ç›˜ï¼‰ ----------
        entry_idx = i + 1
        entry_k = df_s.iloc[entry_idx]
        entry_price = entry_k["open"]
        entry_date = entry_k["date"]
        tp_price = entry_price * (1 - TP)

        max_dd = 0.0
        exit_idx = entry_idx
        exit_price = entry_price
        exit_date = entry_date

        # ---------- æŒä»“é˜¶æ®µ ----------
        for j in range(entry_idx, n):
            k = df_s.iloc[j]

            dd = (k["high"] - entry_price) / entry_price * INVEST * LEVERAGE
            max_dd = max(max_dd, dd)

            # æ­¢ç›ˆåˆ¤æ–­
            if k["low"] <= tp_price:
                exit_idx = j
                exit_price = tp_price
                exit_date = k["date"]
                break
        else:
            last = df_s.iloc[-1]
            exit_idx = last.name
            exit_price = last["close"]
            exit_date = last["date"]

        held_days = exit_idx - entry_idx + 1
        profit = (entry_price - exit_price) / entry_price * INVEST * LEVERAGE

        trades.append({
            "strategy": strategy["name"],
            "symbol": df_s.iloc[0]["symbol"],
            "entry_date": entry_date,
            "entry_price": round(entry_price,6),
            "exit_date": exit_date,
            "exit_price": round(exit_price,6),
            "held_days": held_days,
            "profit": round(profit,2),
            "max_drawdown": round(max_dd,2)
        })

        # ---------- å•åˆçº¦å•ä»“ ----------
        i = exit_idx + 1

    return trades

# ================= ä¸»å›æµ‹æµç¨‹ =================
all_trades = []

for strategy in STRATEGIES:
    print("\n" + "=" * 80)
    print(f"ğŸ“Š å›æµ‹ç­–ç•¥ï¼š{strategy['name']}")

    strategy_trades = []

    for sym in tqdm(df["symbol"].unique(), desc=strategy["name"]):
        df_s = df[df["symbol"] == sym].reset_index(drop=True)
        strategy_trades.extend(backtest_symbol_strategy(df_s, strategy))

    if strategy_trades:
        out = pd.DataFrame(strategy_trades)
        all_trades.append(out)

        total = len(out)
        wins = (out["profit"] > 0).sum()
        winrate = wins / total * 100
        total_profit = out["profit"].sum()
        max_dd = out["max_drawdown"].max()
        avg_hold = out["held_days"].mean()

        print(f"äº¤æ˜“æ¬¡æ•°: {total}")
        print(f"èƒœç‡ï¼ˆè¾¾åˆ° 2% æ”¶ç›Šæ¦‚ç‡ï¼‰: {winrate:.2f}%")
        print(f"ç´¯è®¡æ”¶ç›Š: {total_profit:.2f} USDT")
        print(f"æœ€å¤§æµ®äº: {max_dd:.2f} USDT")
        print(f"å¹³å‡æŒä»“: {avg_hold:.2f} å¤©")

# ================= è¾“å‡º CSV =================
if all_trades:
    trades_df = pd.concat(all_trades, ignore_index=True)
    trades_df.to_csv(TRADES_CSV, index=False)

    summary_df = trades_df.groupby("strategy").agg(
        trades=("profit", "count"),
        winrate=("profit", lambda x: (x > 0).mean() * 100),
        total_profit=("profit", "sum"),
        max_drawdown=("max_drawdown", "max"),
        avg_hold=("held_days", "mean")
    ).reset_index()

    summary_df.to_csv(SUMMARY_CSV, index=False)

    print("\nâœ… å›æµ‹å®Œæˆ")
    print(f"é€ç¬”äº¤æ˜“: {TRADES_CSV}")
    print(f"ç­–ç•¥æ±‡æ€»: {SUMMARY_CSV}")
