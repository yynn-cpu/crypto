# -*- coding: utf-8 -*-
"""
Binance USDT æ°¸ç»­åˆçº¦
1H å®ç›˜æ‰«æå™¨ï¼ˆA_æ”¾é‡æ‹‰å‡å¤±è´¥ï½œåšç©ºï¼‰
å‘½ä¸­å³è¾“å‡ºï¼šå…¥åœºä»· + å½“å‰ä»·
"""

import requests
import pandas as pd
from datetime import timedelta, datetime
import time

# ================= å‚æ•° =================
BASE_URL = "https://fapi.binance.com"
INTERVAL = "1h"
KLINE_LIMIT = 10

# ç­–ç•¥å‚æ•°ï¼ˆä½ çš„æœ€ä¼˜å‚æ•°ï¼‰
VOLUME_MULT = 1.2
LOOKBACK = 3
UPPER_SHADOW_RATIO = 1.5

TIME_OFFSET = timedelta(hours=8)  # åŒ—äº¬æ—¶é—´
SLEEP = 0.15

# ================= å·¥å…·å‡½æ•° =================
def get_all_usdt_symbols():
    r = requests.get(f"{BASE_URL}/fapi/v1/exchangeInfo", timeout=10)
    r.raise_for_status()
    data = r.json()
    return [
        s["symbol"]
        for s in data["symbols"]
        if s["quoteAsset"] == "USDT"
        and s["contractType"] == "PERPETUAL"
    ]


def get_klines(symbol):
    r = requests.get(
        f"{BASE_URL}/fapi/v1/klines",
        params={
            "symbol": symbol,
            "interval": INTERVAL,
            "limit": KLINE_LIMIT
        },
        timeout=10
    )
    r.raise_for_status()

    df = pd.DataFrame(r.json(), columns=[
        "open_time","open","high","low","close","volume",
        "close_time","qav","num_trades","tb","tq","ignore"
    ])

    for c in ["open","high","low","close","volume"]:
        df[c] = df[c].astype(float)

    df["open_time"] = pd.to_datetime(df["open_time"], unit="ms") + TIME_OFFSET
    return df


# ================= é€»è¾‘ Aï¼ˆåšç©ºï¼‰ =================
def trigger_A(df, i):
    if i < LOOKBACK:
        return False

    k = df.iloc[i]

    # å¿…é¡»æ˜¯é˜³çº¿
    if k["close"] <= k["open"]:
        return False

    avg_vol = df["volume"][i-LOOKBACK:i].mean()
    body = abs(k["close"] - k["open"])
    if body == 0:
        return False

    upper_shadow = k["high"] - max(k["open"], k["close"])

    return (
        k["volume"] >= avg_vol * VOLUME_MULT and
        upper_shadow / body >= UPPER_SHADOW_RATIO
    )


# ================= ä¸»ç¨‹åº =================
def main():
    print("\n====== 1H å®ç›˜æ‰«æå¯åŠ¨ï¼ˆå…¨åˆçº¦ï¼‰======")
    print("æ‰«ææ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰ï¼š", datetime.utcnow() + TIME_OFFSET, "\n")

    symbols = get_all_usdt_symbols()
    print(f"USDT æ°¸ç»­åˆçº¦æ•°é‡: {len(symbols)}\n")

    for idx, sym in enumerate(symbols, 1):
        print(f"æ‰«æ {idx}/{len(symbols)}: {sym}")

        try:
            df = get_klines(sym)

            # æœ€è¿‘ä¸€æ ¹ã€å·²æ”¶ç›˜ã€‘
            signal_k = len(df) - 2
            # å½“å‰æ­£åœ¨å½¢æˆçš„ K çº¿
            current_k = len(df) - 1

            if trigger_A(df, signal_k):
                signal_bar = df.iloc[signal_k]
                current_bar = df.iloc[current_k]

                entry_price = current_bar["open"]   # ä¸‹ä¸€æ ¹å¼€ç›˜
                current_price = current_bar["close"]

                print(
                    f"\nğŸš¨ã€åšç©ºä¿¡å·å‘½ä¸­ã€‘{sym}\n"
                    f"  ä¿¡å·Kçº¿æ—¶é—´ : {signal_bar['open_time']}\n"
                    f"  æ”¾é‡ä¸Šå½±å¤±è´¥\n"
                    f"  ğŸ‘‰ å»ºè®®å…¥åœºä»· : {entry_price}\n"
                    f"  ğŸ“ˆ å½“å‰ä»·æ ¼   : {current_price}\n"
                    f"  ï¼ˆä¸‹ä¸€æ ¹ 1H å¼€ç›˜åšç©ºï¼‰\n"
                )

            time.sleep(SLEEP)

        except Exception as e:
            print(f"âŒ {sym} è·å–å¤±è´¥: {e}")

    print("\n====== æ‰«æç»“æŸ ======")


if __name__ == "__main__":
    main()
