# -*- coding: utf-8 -*-
"""
Binance USDT æ°¸ç»­åˆçº¦
30m Kçº¿é‡‡é›†ï¼ˆéšæœº30ä¸ªåˆçº¦ï½œæœ€è¿‘500æ ¹ï¼‰
"""

import requests
import pandas as pd
import time
import random
from datetime import datetime
from requests.adapters import HTTPAdapter
from urllib3.util.retry import Retry

BASE_URL = "https://fapi.binance.com"

# ========= å‚æ•° =========
INTERVAL = "30m"
LIMIT = 500
SLEEP = 0.15
TIMEOUT = 20
RETRIES = 5
RANDOM_SYMBOLS = 30

OUT_FILE = f"usdt_perp_30m_random30_{datetime.now().strftime('%Y%m%d_%H%M')}.csv"

# ================= ç¨³å®š Session =================
def create_session():
    session = requests.Session()
    retry = Retry(
        total=RETRIES,
        backoff_factor=1,
        status_forcelist=[429, 500, 502, 503, 504],
        allowed_methods=["GET"]
    )
    adapter = HTTPAdapter(max_retries=retry)
    session.mount("https://", adapter)
    return session

session = create_session()

# ================= è·å–æ‰€æœ‰ USDT æ°¸ç»­ =================
def get_all_usdt_perp_symbols():
    r = session.get(f"{BASE_URL}/fapi/v1/exchangeInfo", timeout=TIMEOUT)
    data = r.json()

    symbols = [
        s["symbol"]
        for s in data.get("symbols", [])
        if s.get("quoteAsset") == "USDT"
        and s.get("contractType") == "PERPETUAL"
    ]

    return sorted(list(set(symbols)))

# ================= æ‹‰å–æœ€è¿‘ 500 æ ¹ 30m =================
def fetch_latest_klines(symbol):
    params = {
        "symbol": symbol,
        "interval": INTERVAL,
        "limit": LIMIT
    }

    r = session.get(f"{BASE_URL}/fapi/v1/klines", params=params, timeout=TIMEOUT)
    data = r.json()

    if not isinstance(data, list) or len(data) == 0:
        return None

    df = pd.DataFrame(data, columns=[
        "time","open","high","low","close","volume",
        "_","_","_","_","_","_"
    ])

    df = df[["time","open","high","low","close","volume"]].astype(float)
    df["date"] = pd.to_datetime(df["time"], unit="ms")
    df["symbol"] = symbol

    return df[["symbol","date","open","high","low","close","volume"]]

# ================= ä¸»æµç¨‹ =================
all_symbols = get_all_usdt_perp_symbols()
total_all = len(all_symbols)

symbols = random.sample(all_symbols, min(RANDOM_SYMBOLS, total_all))

print(f"ğŸ¯ éšæœºæŠ½å– {len(symbols)} / {total_all} ä¸ª USDT æ°¸ç»­åˆçº¦")
print(f"â± Kçº¿å‘¨æœŸï¼š{INTERVAL} ï½œ æœ€è¿‘ {LIMIT} æ ¹\n")

all_data = []
success = fail = 0

for idx, symbol in enumerate(symbols, 1):
    try:
        print(f"[{idx}/{len(symbols)}] æŠ“å– {symbol}")
        df = fetch_latest_klines(symbol)

        if df is None or df.empty:
            raise Exception("æ— Kçº¿æ•°æ®")

        all_data.append(df)
        success += 1

    except Exception as e:
        print(f"    âš ï¸ {symbol} å¤±è´¥ï¼š{e}")
        fail += 1

    time.sleep(SLEEP)

# ================= ä¿å­˜ =================
final_df = pd.concat(all_data, ignore_index=True)
final_df.sort_values(["symbol", "date"], inplace=True)
final_df.to_csv(OUT_FILE, index=False, encoding="utf-8-sig")

print("\n==================== å®Œæˆ ====================")
print(f"âœ… æˆåŠŸï¼š{success}")
print(f"âš ï¸ å¤±è´¥ï¼š{fail}")
print(f"ğŸ“Š æ€»Kçº¿ï¼š{len(final_df)}")
print(f"ğŸ“ æ–‡ä»¶ï¼š{OUT_FILE}")
