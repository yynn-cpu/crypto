# -*- coding: utf-8 -*-
"""
ğŸš¨ Binance USDT æ°¸ç»­ï½œå®ç›˜æ‰«æå™¨ï¼ˆåªæ‰«æä¸¤ä¸ªå¼ºä¿¡å·é€»è¾‘ï¼‰
é€»è¾‘ï¼š
1. B_4DOWN_LONGï¼šè¿ç»­4å¤©ä¸‹è·Œ â†’ ç¬¬äºŒå¤©å¼€ç›˜åšå¤š
2. BIG_GREEN_THEN_RED_SHORTï¼šå‰ä¸€å¤©å¤§é˜³ååŒ… â†’ ç¬¬äºŒå¤©å¼€ç›˜åšç©º
"""
import pandas as pd
import requests
from datetime import datetime
import time

# ================== å‚æ•° ==================
BASE_URL = "https://fapi.binance.com"
INVEST = 20
LEVERAGE = 20
TP = 0.02  # å›ºå®šæ­¢ç›ˆ 2%
KLINE_LIMIT = 5
BLACKLIST = ["TRXUSDT"]  # é»‘åå•
HISTORY_FILE = r"C:\Users\JZDD\Desktop\backtest_strict\logic17_trades_STRICT.csv"

# ================== è¯»å–å†å²å›æµ‹ ==================
trades_df = pd.read_csv(HISTORY_FILE)

# ================== è·å–æ‰€æœ‰ USDT æ°¸ç»­ ==================
def get_usdt_symbols():
    url = f"{BASE_URL}/fapi/v1/exchangeInfo"
    data = requests.get(url, timeout=10).json()
    symbols = [s["symbol"] for s in data["symbols"] if s["quoteAsset"] == "USDT" and s["status"] == "TRADING"]
    return symbols

# ================== è·å–æœ€è¿‘ K çº¿ ==================
def fetch_last_k(symbol, limit=KLINE_LIMIT):
    url = f"{BASE_URL}/fapi/v1/klines"
    params = {"symbol": symbol, "interval": "1d", "limit": limit}
    r = requests.get(url, params=params, timeout=10).json()
    if not isinstance(r, list) or len(r) < limit:
        return None
    df = pd.DataFrame(r, columns=[
        "open_time","open","high","low","close","volume",
        "close_time","quote_volume","trades","tb_base_av","tb_quote_av","ignore"
    ])
    df[["open","high","low","close","volume"]] = df[["open","high","low","close","volume"]].astype(float)
    return df

# ================== K çº¿å·¥å…· ==================
def candle_down(c):
    return c["close"] < c["open"]

def candle_up(c):
    return c["close"] > c["open"]

# ================== é€»è¾‘åˆ¤æ–­ ==================
def trigger_B_4DOWN_LONG(df):
    if len(df) < 5:
        return False
    # å‰4å¤©è¿ç»­é˜´çº¿
    return all(candle_down(df.iloc[i]) for i in range(-5, -1))

def trigger_BIG_GREEN_THEN_RED_SHORT(df):
    if len(df) < 2:
        return False
    prev = df.iloc[-2]
    last = df.iloc[-1]
    # å‰ä¸€å¤©å¤§é˜³ååŒ… + å½“å¤©æ”¶ç›˜å½¢æˆå¤§é˜´ååŒ…
    return (prev["close"] > prev["open"]*1.07) and candle_down(last)

# ================== å†å²è¡¨ç° ==================
def get_history(symbol, logic_name):
    df = trades_df[(trades_df["symbol"]==symbol) & (trades_df["logic"]==logic_name)]
    if df.empty:
        return None
    trades = len(df)
    win_rate = round((df["profit"]>0).mean()*100,2)
    total_profit = round(df["profit"].sum(),2)
    avg_held = round(df["held_days"].mean(),2)
    max_dd = round(df["max_dd"].max(),2)
    return trades, win_rate, total_profit, avg_held, max_dd

# ================== å®æ—¶æ‰«æ ==================
symbols = get_usdt_symbols()
total = len(symbols)
print("="*80)
print(f"ğŸš¨ Binance USDT æ°¸ç»­ï½œå®ç›˜æ‰«æå¯åŠ¨ï¼ˆå¼ºä¿¡å·é€»è¾‘ï¼‰")
print("é€»è¾‘ï¼šB_4DOWN_LONG / BIG_GREEN_THEN_RED_SHORT")
print("æ—¶é—´ï¼š", datetime.now())
print("="*80)

for idx, symbol in enumerate(symbols, 1):
    if symbol in BLACKLIST:
        print(f"[{idx}/{total}] {symbol} åœ¨é»‘åå•ä¸­ï¼Œè·³è¿‡")
        continue

    df = fetch_last_k(symbol)
    if df is None:
        print(f"[{idx}/{total}] {symbol} Kçº¿æ•°æ®ä¸è¶³ï¼Œè·³è¿‡")
        continue

    # è§¦å‘é€»è¾‘
    trigger_B4 = trigger_B_4DOWN_LONG(df)
    trigger_BGTR = trigger_BIG_GREEN_THEN_RED_SHORT(df)

    # å†å²è¡¨ç°
    hist_B4 = get_history(symbol, "B_4DOWN_LONG")
    hist_BGTR = get_history(symbol, "BIG_GREEN_THEN_RED_SHORT")

    # æ˜¾ç¤º
    print(f"[{idx}/{total}] {symbol}")

    if trigger_B4:
        entry_price = df.iloc[-1]["open"]  # ç¬¬äºŒå¤©å¼€ç›˜å…¥åœº
        tp_price = round(entry_price*(1+TP),6)
        potential_profit = round(INVEST * LEVERAGE * TP,2)
        print(f"  âœ… B_4DOWN_LONG è§¦å‘ | åšå¤š Long | å…¥åœºä»·ï¼š{entry_price} | æŠ•èµ„ï¼š{INVEST}U | æ æ†ï¼š{LEVERAGE}x | TPï¼š{tp_price} | æ½œåœ¨ç›ˆåˆ©ï¼š{potential_profit}USDT")
        if hist_B4:
            trades, win_rate, total_profit, avg_held, max_dd = hist_B4
            print(f"    å†å²è¡¨ç°ï¼š{trades}æ¬¡äº¤æ˜“ï¼Œèƒœç‡{win_rate}% ï¼Œæ€»ç›ˆåˆ©{total_profit}USDTï¼Œå¹³å‡æŒä»“{avg_held}å¤©ï¼Œæœ€å¤§å›æ’¤{max_dd}")
    else:
        print("  âŒ B_4DOWN_LONG æœªè§¦å‘")

    if trigger_BGTR:
        entry_price = df.iloc[-1]["open"]
        tp_price = round(entry_price*(1-TP),6)
        potential_profit = round(INVEST * LEVERAGE * TP,2)
        print(f"  âœ… BIG_GREEN_THEN_RED_SHORT è§¦å‘ | åšç©º Short | å…¥åœºä»·ï¼š{entry_price} | æŠ•èµ„ï¼š{INVEST}U | æ æ†ï¼š{LEVERAGE}x | TPï¼š{tp_price} | æ½œåœ¨ç›ˆåˆ©ï¼š{potential_profit}USDT")
        if hist_BGTR:
            trades, win_rate, total_profit, avg_held, max_dd = hist_BGTR
            print(f"    å†å²è¡¨ç°ï¼š{trades}æ¬¡äº¤æ˜“ï¼Œèƒœç‡{win_rate}% ï¼Œæ€»ç›ˆåˆ©{total_profit}USDTï¼Œå¹³å‡æŒä»“{avg_held}å¤©ï¼Œæœ€å¤§å›æ’¤{max_dd}")
    else:
        print("  âŒ BIG_GREEN_THEN_RED_SHORT æœªè§¦å‘")

    # è¿›åº¦æ˜¾ç¤ºç™¾åˆ†æ¯”
    if idx % 10 == 0 or idx == total:
        pct = round(idx/total*100,2)
        print(f"ğŸ“Š è¿›åº¦ï¼š{pct}%")
    
    time.sleep(0.5)  # é¿å…é¢‘ç¹è¯·æ±‚

print("="*80)
print("âœ… å®ç›˜æ‰«æå®Œæˆ")
print("="*80)
