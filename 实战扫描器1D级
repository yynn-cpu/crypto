# -*- coding: utf-8 -*-
import requests
import pandas as pd
from datetime import datetime
import time

BASE_URL = "https://fapi.binance.com"
TP = 0.02           # æ­¢ç›ˆ2%
INVEST = 20         # æ¯æ¬¡æŠ•å…¥èµ„é‡‘
LEVERAGE = 20       # æ æ†å€æ•°
MAX_RETRIES = 3

THRESHOLDS = [1.12, 1.05]  # é¡ºåºï¼šå…ˆå¼ºä¿¡å·ï¼Œåæ™®é€šä¿¡å·

# ================= å·¥å…·å‡½æ•° =================
def big_green(o, c, ratio):
    return c > o * ratio

def candle_down(o, c):
    return c < o

def request_with_retry(url, timeout=10):
    for _ in range(MAX_RETRIES):
        try:
            r = requests.get(url, timeout=timeout)
            r.raise_for_status()
            return r.json()
        except:
            time.sleep(1)
    return None

def get_symbols():
    data = request_with_retry(f"{BASE_URL}/fapi/v1/exchangeInfo")
    if not data:
        return []
    return [
        s["symbol"]
        for s in data["symbols"]
        if s["contractType"] == "PERPETUAL"
        and s["quoteAsset"] == "USDT"
    ]

def get_recent_klines(symbol):
    url = f"{BASE_URL}/fapi/v1/klines?symbol={symbol}&interval=1d&limit=3"
    data = request_with_retry(url)
    if not data or len(data) < 3:
        return None
    return pd.DataFrame([
        {"open": float(k[1]), "high": float(k[2]), "low": float(k[3]), "close": float(k[4])}
        for k in data
    ])

def get_full_klines(symbol, interval="1d"):
    url = f"{BASE_URL}/fapi/v1/klines?symbol={symbol}&interval={interval}&limit=1000"
    data = request_with_retry(url, timeout=20)
    if not data:
        return None
    return pd.DataFrame([
        {"open": float(k[1]), "high": float(k[2]), "low": float(k[3]), "close": float(k[4])}
        for k in data
    ])

# ================= å›æµ‹é€»è¾‘ =================
def backtest_symbol(df_s, ratio):
    trades = []
    n = len(df_s)
    if n < 5:
        return []

    for i in range(1, n - 2):
        prev, curr, nxt = df_s.iloc[i - 1], df_s.iloc[i], df_s.iloc[i + 1]
        if big_green(prev["open"], prev["close"], ratio) and candle_down(curr["open"], curr["close"]):
            entry_price = nxt["open"]
            tp_price = entry_price * (1 - TP)
            exit_price = df_s.iloc[-1]["close"]
            held_days = 0
            max_dd = 0

            for j in range(i + 1, n):
                high, low = df_s.iloc[j]["high"], df_s.iloc[j]["low"]
                held_days += 1
                max_dd = max(max_dd, (high - entry_price) / entry_price * INVEST * LEVERAGE)
                if low <= tp_price:
                    exit_price = tp_price
                    break

            profit = (entry_price - exit_price) / entry_price * INVEST * LEVERAGE
            trades.append({
                "entry": entry_price,
                "exit": exit_price,
                "profit": profit,
                "drawdown": max_dd,
                "held": held_days
            })
    return trades

def summarize_trades(trades):
    if not trades:
        return None
    df = pd.DataFrame(trades)
    wins = len(df[df["profit"] > 0])
    losses = len(df) - wins
    winrate = wins / len(df) * 100
    max_dd = df["drawdown"].max()
    max_held = df["held"].max()
    total_profit = df["profit"].sum()
    return {
        "trades": len(df),
        "winrate": round(winrate, 2),
        "max_drawdown": round(max_dd, 2),
        "max_held": max_held,
        "total_profit": round(total_profit, 2)
    }

# ================= ä¸»æ‰«æ =================
def scan():
    symbols = get_symbols()
    print("\n================= æ—¥çº¿åšç©ºæ™¨æ‰« =================")
    print(f"æ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print(f"åˆçº¦æ•°é‡: {len(symbols)}")
    print("è§„åˆ™ï¼šç¬¬1å¤©å¤§é˜³ â†’ ç¬¬2å¤©é˜´çº¿ â†’ ç¬¬3å¤©å¼€ç›˜åšç©º")
    print("===============================================\n")

    seen_symbols = set()

    for ratio in THRESHOLDS:
        print(f"\nğŸ”¥ å¼€å§‹æ‰«æé˜ˆå€¼ {ratio:.2f}")
        print("-" * 60)

        for idx, sym in enumerate(symbols, 1):
            print(f"\rè¿›åº¦ {idx}/{len(symbols)}", end="")

            if sym in seen_symbols:
                continue

            df_recent = get_recent_klines(sym)
            if df_recent is None or len(df_recent) < 3:
                continue

            prev, curr, nxt = df_recent.iloc[0], df_recent.iloc[1], df_recent.iloc[2]
            if big_green(prev["open"], prev["close"], ratio) and candle_down(curr["open"], curr["close"]):
                df_full = get_full_klines(sym)
                if df_full is None:
                    continue

                trades = backtest_symbol(df_full, ratio)
                summary = summarize_trades(trades)

                label = "å¤§é˜³ â‰¥12%" if ratio == 1.12 else "å¤§é˜³ â‰¥5%"
                seen_symbols.add(sym)

                print("\n")
                print(f"ğŸ“Œ åˆçº¦: {sym}")
                print(f"âš¡ ä¿¡å·: {label}")
                print(f"ğŸ“ˆ é˜ˆå€¼: {ratio}")
                print(f"ğŸŸ¢ ç†è®ºå…¥åœºä»·: {nxt['open']}")
                print(f"ğŸ”´ å½“å‰æ”¶ç›˜ä»·: {nxt['close']}")

                if summary:
                    print(f"ğŸ“Š å†å²è§¦å‘æ¬¡æ•°: {summary['trades']}")
                    print(f"èƒœç‡: {summary['winrate']}%")
                    print(f"æœ€å¤§æµ®äº: {summary['max_drawdown']} USDT")
                    print(f"æœ€é•¿æŒä»“å¤©æ•°: {summary['max_held']}")
                    print(f"ç´¯è®¡å‡€æ”¶ç›Š: {summary['total_profit']} USDT")
                else:
                    print("ï¼ˆå†å²æ ·æœ¬å¤ªå°‘ï¼‰")
                print("-" * 60)

    print("\nâœ… æ‰«æå®Œæˆ")

if __name__ == "__main__":
    scan()
