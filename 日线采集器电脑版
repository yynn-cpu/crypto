# -*- coding: utf-8 -*-
"""
Binance USDT æ°¸ç»­åˆçº¦
å…¨é‡å†å² 1D K çº¿é‡‡é›†ï¼ˆè¶…ç¨³å®šç‰ˆï½œå•è¡¨ï¼‰
"""

import requests
import pandas as pd
import time
from datetime import datetime
from requests.adapters import HTTPAdapter
from urllib3.util.retry import Retry

BASE_URL = "https://fapi.binance.com"
LIMIT = 500          # å…³é”®ï¼šä¸è¦ 1000
SLEEP = 0.15         # æ…¢ä¸€ç‚¹ï¼Œç¨³
TIMEOUT = 20
RETRIES = 5

OUT_FILE = f"all_usdt_perp_1d_{datetime.now().strftime('%Y%m%d_%H%M')}.csv"

# ================= åˆ›å»ºç¨³å®š Session =================
def create_session():
    session = requests.Session()
    retry = Retry(
        total=RETRIES,
        backoff_factor=1,
        status_forcelist=[429, 500, 502, 503, 504],
        allowed_methods=["GET"]
    )
    adapter = HTTPAdapter(max_retries=retry)
    session.mount("https://", adapter)
    session.mount("http://", adapter)
    return session

session = create_session()

# ================= è·å– USDT æ°¸ç»­ =================
def get_usdt_symbols():
    r = session.get(f"{BASE_URL}/fapi/v1/exchangeInfo", timeout=TIMEOUT)
    data = r.json()
    return [
        s["symbol"] for s in data["symbols"]
        if s["quoteAsset"] == "USDT"
        and s["status"] == "TRADING"
        and s["contractType"] == "PERPETUAL"
    ]

# ================= æ‹‰å–å•åˆçº¦å…¨å†å² =================
def fetch_all_1d(symbol):
    all_rows = []
    end_time = None
    batch = 0

    while True:
        params = {
            "symbol": symbol,
            "interval": "1d",
            "limit": LIMIT
        }
        if end_time:
            params["endTime"] = end_time

        r = session.get(
            f"{BASE_URL}/fapi/v1/klines",
            params=params,
            timeout=TIMEOUT
        )

        data = r.json()
        if not isinstance(data, list) or len(data) == 0:
            break

        all_rows = data + all_rows
        end_time = data[0][0] - 1
        batch += 1

        print(f"    â†³ {symbol} ç¬¬ {batch} æ‰¹ï¼Œç´¯è®¡ {len(all_rows)} æ ¹")

        if len(data) < LIMIT:
            break

        time.sleep(SLEEP)

    if not all_rows:
        return None

    df = pd.DataFrame(all_rows, columns=[
        "time","open","high","low","close","volume",
        "_","_","_","_","_","_"
    ])
    df = df[["time","open","high","low","close","volume"]].astype(float)
    df["date"] = pd.to_datetime(df["time"], unit="ms")
    df["symbol"] = symbol

    return df[["symbol","date","open","high","low","close","volume"]]

# ================= ä¸»æµç¨‹ =================
symbols = get_usdt_symbols()
total = len(symbols)

print(f"ğŸ” å…±å‘ç° {total} ä¸ª USDT æ°¸ç»­åˆçº¦ï¼Œå¼€å§‹æŠ“å–æ—¥çº¿æ•°æ®\n")

all_data = []
success = 0
partial = 0
fail = 0

for idx, symbol in enumerate(symbols, 1):
    try:
        print(f"[{idx}/{total}] æŠ“å– {symbol} ...")
        df = fetch_all_1d(symbol)

        if df is None or df.empty:
            raise Exception("æ— æ•°æ®")

        all_data.append(df)
        print(f"    âœ… å®Œæˆ {symbol}ï¼Œå…± {len(df)} æ ¹")
        success += 1

    except Exception as e:
        print(f"    âš ï¸ {symbol} æŠ“å–å¼‚å¸¸ï¼Œè·³è¿‡ï¼ˆ{e}ï¼‰")
        fail += 1

    time.sleep(SLEEP)

# ================= ä¿å­˜ =================
final_df = pd.concat(all_data, ignore_index=True)
final_df.sort_values(["symbol", "date"], inplace=True)
final_df.to_csv(OUT_FILE, index=False, encoding="utf-8-sig")

print("\n==================== å®Œæˆ ====================")
print(f"âœ… æˆåŠŸï¼š{success}")
print(f"âš ï¸ å¤±è´¥è·³è¿‡ï¼š{fail}")
print(f"ğŸ“ è¾“å‡ºæ–‡ä»¶ï¼š{OUT_FILE}")
print(f"ğŸ“Š æ€»è¡Œæ•°ï¼š{len(final_df)}")
