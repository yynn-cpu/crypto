# -*- coding: utf-8 -*-
"""
ğŸ“Š æœ¬åœ° CSV å¤šé˜ˆå€¼ BIG_GREEN_THEN_RED_SHORT å›æµ‹
ã€ä¸¥æ ¼ç‰ˆã€‘
- i-1ï¼šå¤§é˜³
- i  ï¼šæ”¶é˜´ï¼ˆç¡®è®¤ï¼‰
- i+1ï¼šå¼€ç›˜åšç©º
- åŒä¸€åˆçº¦åŒä¸€æ—¶é—´åªå…è®¸ä¸€ç¬”æŒä»“
- å›ºå®š 2% æ­¢ç›ˆ
- å®Œå…¨æ— æœªæ¥å‡½æ•°
"""

import pandas as pd
from tqdm import tqdm

# ================= å‚æ•° =================
CSV_FILE = r"C:\Users\1\all_usdt_perp_1d_20251225_2256.csv"
OUTPUT_CSV = r"C:\Users\1\Desktop\big_green_red_backtest_tp2_SINGLE_POSITION.csv"

INVEST = 20
LEVERAGE = 20
TP = 0.02
THRESHOLDS = [1.05, 1.12]

# ================= è¯»å–æ•°æ® =================
df = pd.read_csv(CSV_FILE)
df[["open", "high", "low", "close"]] = df[["open", "high", "low", "close"]].astype(float)
df["date"] = pd.to_datetime(df["date"])
df = df.sort_values(["symbol", "date"]).reset_index(drop=True)

# ================= å·¥å…·å‡½æ•° =================
def is_big_green(c, ratio):
    return c["close"] > c["open"] * ratio

def is_red(c):
    return c["close"] < c["open"]

# ================= å›æµ‹å‡½æ•°ï¼ˆå•åˆçº¦ï½œå•ä»“ï¼‰ =================
def backtest_symbol(df_s, ratio):
    trades = []
    n = len(df_s)
    i = 1  # ä»ç¬¬äºŒæ ¹Kå¼€å§‹

    while i < n - 1:
        prev = df_s.iloc[i - 1]
        curr = df_s.iloc[i]

        # ---------- ä¿¡å·æœªæ»¡è¶³ ----------
        if not (is_big_green(prev, ratio) and is_red(curr)):
            i += 1
            continue

        # ---------- å¼€ä»“ï¼ˆi+1 å¼€ç›˜ï¼‰ ----------
        entry_idx = i + 1
        entry = df_s.iloc[entry_idx]
        entry_price = entry["open"]
        entry_date = entry["date"]
        tp_price = entry_price * (1 - TP)

        max_drawdown = 0.0
        exit_price = entry_price
        exit_date = entry_date
        exit_idx = entry_idx

        # ---------- æŒä»“é˜¶æ®µï¼ˆé”ä»“ï¼‰ ----------
        for j in range(entry_idx, n):
            k = df_s.iloc[j]

            # ç©ºå•æµ®äºï¼ˆçœ‹æœ€é«˜ä»·ï¼‰
            dd = (k["high"] - entry_price) / entry_price * INVEST * LEVERAGE
            max_drawdown = max(max_drawdown, dd)

            # æ­¢ç›ˆ
            if k["low"] <= tp_price:
                exit_price = tp_price
                exit_date = k["date"]
                exit_idx = j
                break
        else:
            # æœªæ­¢ç›ˆï¼Œæœ€åä¸€æ ¹Kå¼ºåˆ¶å¹³ä»“
            last = df_s.iloc[-1]
            exit_price = last["close"]
            exit_date = last["date"]
            exit_idx = last.name

        held_days = exit_idx - entry_idx + 1
        profit = (entry_price - exit_price) / entry_price * INVEST * LEVERAGE

        trades.append({
            "symbol": df_s.iloc[0]["symbol"],
            "threshold": round(ratio, 2),
            "entry_date": entry_date,
            "entry_price": round(entry_price, 6),
            "exit_date": exit_date,
            "exit_price": round(exit_price, 6),
            "held_days": held_days,
            "profit": round(profit, 2),
            "max_drawdown": round(max_drawdown, 2)
        })

        # â­â­â­ æ ¸å¿ƒï¼šè·³è¿‡æ•´ä¸ªæŒä»“åŒºé—´ â­â­â­
        i = exit_idx + 1

    return trades

# ================= ä¸»ç¨‹åº =================
symbols = df["symbol"].unique()
all_trades = []

for ratio in THRESHOLDS:
    print("\n" + "=" * 80)
    print(f"ğŸ“Š å›æµ‹é˜ˆå€¼ {ratio:.2f}")

    ratio_trades = []

    for sym in tqdm(symbols, desc=f"å›æµ‹ä¸­ {ratio:.2f}"):
        df_s = df[df["symbol"] == sym].reset_index(drop=True)
        ratio_trades.extend(backtest_symbol(df_s, ratio))

    if ratio_trades:
        out = pd.DataFrame(ratio_trades)
        all_trades.append(out)

        total = len(out)
        wins = (out["profit"] > 0).sum()
        winrate = wins / total * 100
        max_hold = out["held_days"].max()
        max_dd = out["max_drawdown"].max()
        total_profit = out["profit"].sum()

        print(f"è§¦å‘æ¬¡æ•°: {total}")
        print(f"èƒœç‡: {winrate:.2f}%")
        print(f"æœ€é•¿æŒä»“: {max_hold} å¤©")
        print(f"æœ€å¤§æµ®äº: {max_dd:.2f} USDT")
        print(f"ç´¯è®¡æ”¶ç›Š: {total_profit:.2f} USDT")
    else:
        print("âš  æ— è§¦å‘")

# ================= è¾“å‡º CSV =================
if all_trades:
    final_df = pd.concat(all_trades, ignore_index=True)
    final_df.to_csv(OUTPUT_CSV, index=False)
    print(f"\nâœ… å·²è¾“å‡ºã€å•åˆçº¦å•ä»“ã€‘å›æµ‹ç»“æœï¼š\n{OUTPUT_CSV}")
