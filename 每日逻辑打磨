# -*- coding: utf-8 -*-
"""
ğŸ“Š æœ¬åœ° CSV å›æµ‹ Â· æ‰›å•é£æ ¼ä¼˜åŒ–ï¼ˆæ— æœªæ¥å‡½æ•°ï¼‰
- ä¿ç•™å¥½çš„é€»è¾‘ + æ–°è®¾è®¡ 5 æ¡é€»è¾‘
- NEW3 å’Œ NEW5 å·²æ”¹å†™ä¸ºå®‰å…¨ç‰ˆ
- è¾“å‡º CSV åŒ…å«å…¥åœº/ç¦»åœºä»·æ ¼ã€äº¤æ˜“è¯¦æƒ…
- æ§åˆ¶å°è¾“å‡ºæ‰›å•ç»Ÿè®¡æŒ‡æ ‡
"""

import pandas as pd
from tqdm import tqdm

# ================= å‚æ•° =================
CSV_FILE = r"C:\Users\1\all_usdt_perp_1d_20251225_2256.csv"
OUT_TRADES = r"C:\Users\1\OPTIMIZED_SHORT_STRATEGIES_SAFE_trades.csv"

INVEST = 20
LEVERAGE = 20
TP = 0.02  # æ­¢ç›ˆ 2%

# ================= æ•°æ®åŠ è½½ =================
df = pd.read_csv(CSV_FILE)
for col in ["open", "high", "low", "close", "volume"]:
    df[col] = df[col].astype(float)
df["date"] = pd.to_datetime(df["date"])
df = df.sort_values(["symbol", "date"]).reset_index(drop=True)
print("âœ… æ•°æ®åŠ è½½å®Œæˆ")
print(f"åˆçº¦æ•°é‡ï¼š{df['symbol'].nunique()}")

# ================= ç­–ç•¥å‡½æ•° =================

# åŸæœ‰æ— æœªæ¥å‡½æ•°ç­–ç•¥
def BIG_GREEN_RED_5(df, i):
    d2, d1 = df.iloc[i-2], df.iloc[i-1]
    return d2["close"] >= d2["open"] * 1.05 and d1["close"] < d1["open"]

def L3_BIG_GREEN_HAMMER(df, i):
    d1 = df.iloc[i-1]
    upper_shadow = d1["high"] - max(d1["open"], d1["close"])
    candle_body = abs(d1["close"] - d1["open"])
    return (d1["close"] >= d1["open"] * 1.05) and (upper_shadow / candle_body >= 0.3)

def L1_TWO_BIG_GREEN_ONE_RED(df, i):
    d3, d2, d1 = df.iloc[i-3], df.iloc[i-2], df.iloc[i-1]
    return d3["close"] >= d3["open"] * 1.05 and d2["close"] >= d2["open"] * 1.05 and d1["close"] < d1["open"]

# æ”¹å†™åçš„å®‰å…¨ç­–ç•¥ï¼ˆæ— æœªæ¥å‡½æ•°ï¼‰
def NEW1_LONG_SHADOW_REVERSE(df, i):
    d2, d1 = df.iloc[i-2], df.iloc[i-1]
    return d1["close"] >= d1["open"] * 1.05 and d2["open"] < d1["close"]

def NEW2_TWO_DAY_GREEN_DROP(df, i):
    d4, d3, d2, d1 = df.iloc[i-4], df.iloc[i-3], df.iloc[i-2], df.iloc[i-1]
    return d3["close"] >= d3["open"] and d2["close"] >= d2["open"] and d1["open"] < d2["close"]

# NEW3 å®‰å…¨ç‰ˆï¼šç”¨å‰ä¸€å¤©å¯¹æ¯”å‰ä¸¤å¤©
def NEW3_HIGH_LOW_REVERSAL_SAFE(df, i):
    d2, d1 = df.iloc[i-2], df.iloc[i-1]
    return d1["high"] > d2["high"] and d1["close"] < d2["close"]

# NEW4 åŸé€»è¾‘æ— æœªæ¥å‡½æ•°
def NEW4_VOLUME_SPIKE_FAIL(df, i):
    d2, d1 = df.iloc[i-2], df.iloc[i-1]
    return d2["close"] >= d2["open"] and d1["volume"] > 1.5*d2["volume"] and d1["open"] < d2["close"]

# NEW5 å®‰å…¨ç‰ˆï¼šç”¨å‰ä¸€å¤©ç¼©å°å®ä½“ + å‰ä¸¤å¤©å¤§é˜³
def NEW5_SMALL_BODY_REVERSE_SAFE(df, i):
    d2, d1 = df.iloc[i-2], df.iloc[i-1]
    return d2["close"] >= d2["open"]*1.05 and abs(d1["close"]-d1["open"]) < (d1["high"]-d1["low"])*0.3 and d1["close"] < d1["open"]

# ================= ç­–ç•¥åˆ—è¡¨ =================
STRATEGIES = [
    ("BIG_GREEN_RED_5%", "SHORT", BIG_GREEN_RED_5),
    ("L3_BIG_GREEN_HAMMER", "SHORT", L3_BIG_GREEN_HAMMER),
    ("L1_TWO_BIG_GREEN_ONE_RED", "SHORT", L1_TWO_BIG_GREEN_ONE_RED),
    ("NEW1_LONG_SHADOW_REVERSE", "SHORT", NEW1_LONG_SHADOW_REVERSE),
    ("NEW2_TWO_DAY_GREEN_DROP", "SHORT", NEW2_TWO_DAY_GREEN_DROP),
    ("NEW3_HIGH_LOW_REVERSAL_SAFE", "SHORT", NEW3_HIGH_LOW_REVERSAL_SAFE),
    ("NEW4_VOLUME_SPIKE_FAIL", "SHORT", NEW4_VOLUME_SPIKE_FAIL),
    ("NEW5_SMALL_BODY_REVERSE_SAFE", "SHORT", NEW5_SMALL_BODY_REVERSE_SAFE)
]

# ================= å›æµ‹ =================
trades = []

for sym in tqdm(df["symbol"].unique(), desc="å›æµ‹ä¸­"):
    sdf = df[df["symbol"] == sym].reset_index(drop=True)
    n = len(sdf)

    for i in range(4, n-1):
        entry = sdf.iloc[i]

        for name, direction, func in STRATEGIES:
            if not func(sdf, i):
                continue

            entry_price = entry["open"]
            tp_price = entry_price * (1 - TP)  # åšç©ºæ­¢ç›ˆ

            max_dd = 0.0
            exit_price = None
            exit_idx = None

            for j in range(i, n):
                k = sdf.iloc[j]
                dd = (k["high"] - entry_price) / entry_price * INVEST * LEVERAGE
                max_dd = max(max_dd, dd)

                # æ­¢ç›ˆåˆ¤æ–­
                if k["low"] <= tp_price:
                    exit_price = tp_price
                    exit_idx = j
                    break

            if exit_price is None:
                exit_price = sdf.iloc[-1]["close"]
                exit_idx = n - 1

            profit = (entry_price - exit_price) / entry_price * INVEST * LEVERAGE

            trades.append({
                "strategy": name,
                "direction": direction,
                "symbol": sym,
                "entry_date": entry["date"],
                "exit_date": sdf.iloc[exit_idx]["date"],
                "entry_price": round(entry_price,6),
                "exit_price": round(exit_price,6),
                "profit_usdt": round(profit,4),
                "max_drawdown_usdt": round(max_dd,4),
                "hold_days": exit_idx - i + 1
            })

# ================= è¾“å‡º =================
tdf = pd.DataFrame(trades)
tdf.to_csv(OUT_TRADES, index=False, encoding="utf-8-sig")

print("\n" + "=" * 80)
print("ğŸ“Š æ‰›å•è§†è§’ Â· ç­–ç•¥ç»Ÿè®¡")

for name in tdf["strategy"].unique():
    sdf = tdf[tdf["strategy"] == name]
    total_profit = sdf["profit_usdt"].sum()
    max_dd = sdf["max_drawdown_usdt"].max()
    ratio = total_profit / max_dd if max_dd > 0 else float("inf")

    print("\n" + "-"*60)
    print(f"ç­–ç•¥ï¼š{name}")
    print(f"æ–¹å‘ï¼š{sdf.iloc[0]['direction']}")
    print(f"äº¤æ˜“æ¬¡æ•°ï¼š{len(sdf)}")
    print(f"å†å²æ€»è·åˆ©ï¼š{total_profit:.2f} USDT")
    print(f"æœ€å¤§å•ç¬”å›æ’¤ï¼š{max_dd:.2f} USDT")
    print(f"è·åˆ© / æœ€å¤§å›æ’¤ æ¯”ï¼š{ratio:.2f}")
    print(f"å¹³å‡æŒä»“å¤©æ•°ï¼š{sdf['hold_days'].mean():.2f} å¤©")

print("\nğŸ“ é€ç¬”äº¤æ˜“ CSV è¾“å‡ºï¼š", OUT_TRADES)
